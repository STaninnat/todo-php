services:
  php-fpm:
    build:
      context: ./backend
      dockerfile: Dockerfile.test
    image: todo-backend:test
    container_name: php_fpm_test
    env_file:
      - .env.test
    volumes:
      - ./backend/src:/app/src
      - ./backend/public:/app/public
      - ./backend/tests:/app/tests
      - ./backend/vendor:/app/vendor
      - ./backend/composer.json:/app/composer.json
      - ./backend/composer.lock:/app/composer.lock
      - ./backend/phpunit.integration.xml.dist:/app/phpunit.integration.xml.dist
      - ./backend/phpunit.unit.xml.dist:/app/phpunit.unit.xml.dist
      - ./backend/phpunit.xml.dist:/app/phpunit.xml.dist
      - ./backend/phpunit.e2e.xml:/app/phpunit.e2e.xml
      - ./backend/phinx.php:/app/phinx.php
      - ./backend/db:/app/db
    environment:
      APP_ENV: ${APP_ENV:-testing}
      APP_DEBUG: ${APP_DEBUG:-true}
    depends_on:
      - db_test
    networks:
      - app_test_network
    profiles: ["test"]

  db_test:
    image: mysql:8.0
    container_name: mysql_db_test
    env_file:
      - .env.test
    ports:
      - "3307:3306"
    volumes:
      - db_test_data:/var/lib/mysql
    networks:
      - app_test_network
    profiles: ["test"]

volumes:
  db_test_data:

networks:
  app_test_network:
