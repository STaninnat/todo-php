services:
  php-fpm:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: dev
    image: todo-backend:dev
    container_name: php_fpm
    volumes:
      - ./backend/src:/app/src
      - ./backend/public:/app/public
      - ./backend/vendor:/app/vendor
      - ./backend/composer.json:/app/composer.json
      - ./backend/composer.lock:/app/composer.lock
      - ./backend/phinx.php:/app/phinx.php
      - ./backend/db:/app/db
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

      # --- Future Cloud Logging Examples ---
      #
      # 1. AWS CloudWatch (requires AWS credentials on host)
      # driver: "awslogs"
      # options:
      #   awslogs-region: "us-east-1"
      #   awslogs-group: "todo-app-logs"
      #   awslogs-stream: "php-fpm"
      #
      # 2. Google Cloud Logging (requires GCP credentials on host)
      # driver: "gcplogs"
      # options:
      #   gcp-project: "my-gcp-project-id"
      #   gcp-log-cmd: "true"
      
    environment:
      DB_HOST: ${DB_HOST}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASS: ${DB_PASS}
      APP_ENV: ${APP_ENV:-development}
      APP_DEBUG: ${APP_DEBUG:-true}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      - db
    networks:
      - app_network

  nginx:
    image: nginx:stable-alpine
    container_name: nginx_web
    ports:
      - "${APP_PORT:-8085}:80"
    volumes:
      # Reuse the frontend Nginx config for consistency (Dev Gateway role)
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - php-fpm
    networks:
      - app_network

  db:
    image: mysql:8.0
    container_name: mysql_db
    ports:
      - "${DB_PORT:-3306}:3306"
    volumes:
      - db_data:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-tododb}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    networks:
      - app_network

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: phpmyadmin
    depends_on:
      - db
    ports:
      - "${PHPMYADMIN_PORT:-8086}:80"
    environment:
      PMA_HOST: db
      PMA_PORT: 3306
      UPLOAD_LIMIT: ${PHPMYADMIN_UPLOAD_LIMIT:-64M}
    networks:
      - app_network

volumes:
  db_data:

networks:
  app_network:
