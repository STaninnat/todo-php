@startuml backend-auth-flow
title User Authentication Flows

actor Client
participant "Router" as Router
participant "UserController" as Ctrl
participant "Sign(up|in|out)Service" as Service
participant "UserQueries" as DB
participant "JwtService" as JWT
participant "CookieManager" as Cookie
participant "RefreshTokenService" as RefreshSvc
participant "RefreshTokenQueries" as RefreshDB

== User Sign-Up Flow ==

Client -> Router: POST /users/signup\n(username, email, password)
activate Router
Router -> Ctrl: signup(req)
activate Ctrl
Ctrl -> Service: SignupService->execute(req)
activate Service

Service -> Service: Validate Input
Service -> DB: checkUserExists(username, email)
activate DB
DB --> Service: boolean
deactivate DB

alt User Exists
    Service --> Ctrl: Throw InvalidArgumentException
    Ctrl --> Router: Throw Exception
    Router --> Client: 400 Bad Request
else New User
    Service -> Service: password_hash(password)
    Service -> DB: createUser(id, username, email, hash)
    activate DB
    DB --> Service: User Data
    deactivate DB

    Service -> JWT: createAccess(['id' => user.id])
    activate JWT
    JWT --> Service: Access Token
    deactivate JWT

    Service -> JWT: createRefresh(['id' => user.id])
    activate JWT
    JWT --> Service: Refresh Token
    deactivate JWT

    Service -> RefreshSvc: create(user.id, token, expiresAt)
    activate RefreshSvc
    RefreshSvc -> RefreshDB: create(...)
    activate RefreshDB
    RefreshDB --> RefreshSvc: void
    deactivate RefreshDB
    RefreshSvc --> Service: void
    deactivate RefreshSvc

    Service -> Cookie: setAccessToken(token, expiry)
    activate Cookie
    Cookie --> Service: void
    deactivate Cookie

    Service -> Cookie: setRefreshToken(token, expiry)
    activate Cookie
    Cookie --> Service: void
    deactivate Cookie

    Service --> Ctrl: void
    Ctrl --> Router: JsonResponder::quickSuccess()
    Router --> Client: 200 OK (Set-Cookie: access_token, refresh_token)
end
deactivate Service
deactivate Ctrl
deactivate Router

== User Sign-In Flow ==

Client -> Router: POST /users/signin\n(username, password)
activate Router
Router -> Ctrl: signin(req)
activate Ctrl
Ctrl -> Service: SigninService->execute(req)
activate Service

Service -> Service: Validate Input
Service -> DB: getUserByName(username)
activate DB
DB --> Service: User Data (Hash)
deactivate DB

Service -> Service: password_verify(password, hash)

alt Invalid Credentials
    Service --> Ctrl: Throw InvalidArgumentException
    Ctrl --> Router: Throw Exception
    Router --> Client: 400 Bad Request
else Valid Credentials
    Service -> JWT: createAccess(['id' => user.id])
    activate JWT
    JWT --> Service: Access Token
    deactivate JWT
    
    Service -> JWT: createRefresh(['id' => user.id])
    activate JWT
    JWT --> Service: Refresh Token
    deactivate JWT

    Service -> RefreshSvc: create(user.id, token, expiresAt)
    activate RefreshSvc
    RefreshSvc -> RefreshDB: create(...)
    activate RefreshDB
    RefreshDB --> RefreshSvc: void
    deactivate RefreshDB
    RefreshSvc --> Service: void
    deactivate RefreshSvc

    Service -> Cookie: setAccessToken(token, expiry)
    activate Cookie
    Cookie --> Service: void
    deactivate Cookie

    Service -> Cookie: setRefreshToken(token, expiry)
    activate Cookie
    Cookie --> Service: void
    deactivate Cookie

    Service --> Ctrl: void
    Ctrl --> Router: JsonResponder::quickSuccess()
    Router --> Client: 200 OK (Set-Cookie: access_token, refresh_token)
end
deactivate Service
deactivate Ctrl
deactivate Router

== User Sign-Out Flow ==

Client -> Router: POST /users/signout
activate Router
Router -> Ctrl: signout(req)
activate Ctrl
Ctrl -> Service: SignoutService->execute()
activate Service

Service -> Cookie: clearAccessToken()
activate Cookie
Cookie --> Service: void
deactivate Cookie

Service -> Cookie: clearRefreshToken()
activate Cookie
Cookie --> Service: void
deactivate Cookie

Service --> Ctrl: void
deactivate Service
Ctrl --> Router: JsonResponder::quickSuccess()
deactivate Ctrl
Router --> Client: 200 OK (Set-Cookie: keys deleted)
deactivate Router

@enduml
