@startuml backend-request-diagram
title Backend Request Flow

actor Client
participant "index.php" as Index
participant "RouterApp" as App
participant "Router" as Router
participant "Request" as Req
participant "Global Middlewares" as GMW
participant "AuthMiddleware" as AuthMW
participant "Controller" as Ctrl
participant "Service" as Svc
database "Database" as DB

Client -> Index: HTTP Request
activate Index

Index -> App: new RouterApp(router, logger, db)
activate App
App -> App: // Setup DI & Controllers //
App -> App: registerMiddlewares()
App -> App: registerRoutes()
deactivate App

Index -> Router: addMiddleware(DebugMiddleware)

Index -> App: dispatch()
activate App

App -> Router: dispatch()
activate Router

Router -> Req: new Request()
activate Req
Req --> Router: request object
deactivate Req

Router -> Router: Match Route

group Global Middlewares
    Router -> GMW: CorsMiddleware(req)
    activate GMW
    GMW --> Router
    deactivate GMW

    Router -> GMW: DebugMiddleware(req)
    activate GMW
    GMW --> Router
    deactivate GMW

    Router -> AuthMW: refreshJwt(req)
    activate AuthMW
    AuthMW --> Router
    deactivate AuthMW
end

group Route Middlewares (Protected Routes)
    Router -> AuthMW: requireAuth(req)
    activate AuthMW
    AuthMW --> Router
    deactivate AuthMW
end

Router -> Ctrl: handle(req)
activate Ctrl

Ctrl -> Svc: execute business logic
activate Svc
Svc -> Svc: validate / process
Svc -> DB: query
activate DB
DB --> Svc: result
deactivate DB
Svc --> Ctrl: data
deactivate Svc

Ctrl --> Router: response (data or JsonResponder)
deactivate Ctrl

Router --> App: response array
deactivate Router

App --> Index: response array
deactivate App

Index -> Client: JSON Response
deactivate Index

@enduml
